<link rel="import" href="../polymer/polymer.html">

<!--
`scary-mdx-table`

@demo demo/index.html
-->

<dom-module id="scary-mdx-table">
  <template>
    <style>
      .table {
        display: table;
        border-collapse: collapse;
        @apply(--scary-mdx-table);
      }

      .row {
        display: table-row;
        @apply(--scary-mdx-row);
      }

      .row[hidden] {
        display: none;
      }

      .cell {
        display: table-cell;
        padding: 1px 5px;
        @apply(--scary-mdx-cell);
      }

      .row.body:nth-child(odd) {
        @apply(--scary-mdx-row-odd);
      }

      .row.body:nth-child(even) {
        @apply(--scary-mdx-row-even);
      }

      .value {
        text-align: right;
        @apply(--scary-mdx-value);
      }

      .col-caption {
        font-weight: bold;
        text-align: right;
        @apply(--scary-mdx-col-caption);
      }

      .col-header {
        font-weight: bold;
        @apply(--scary-mdx-col-header);
      }

      .row-header {
        font-weight: bold;
        cursor: pointer;
        @apply(--scary-mdx-row-header);
      }

      [level] {
        padding-left: 10em;
      }
      [level="0"] {
        padding-left: 0;
      }
      [level="1"] {
        padding-left: 1em;
      }
      [level="2"] {
        padding-left: 2em;
      }
      [level="3"] {
        padding-left: 3em;
      }
      [level="4"] {
        padding-left: 4em;
      }
      [level="5"] {
        padding-left: 5em;
      }
      [level="6"] {
        padding-left: 6em;
      }
      [level="7"] {
        padding-left: 7em;
      }
      [level="8"] {
        padding-left: 8em;
      }
      [level="9"] {
        padding-left: 9em;
      }
    </style>
    <div class="table">
      <template is="dom-repeat" items="[[colHeaders]]" as="colinfo" index-as="colNo">
        <div class="row">
          <template is="dom-repeat" items="[[rowHeaders]]">
            <span class="cell col-caption">[[colinfo.name]]</span>
          </template>
          <template is="dom-repeat" items="[[cols.Tuples]]" as="col">
            <span class="cell col-header">[[_getColName(col, colNo)]]</span>
          </template>
        </div>
      </template>
      <template is="dom-repeat" items="[[rows.Tuples]]" as="row" index-as="rowNo">
        <div class="row body" hidden$="[[row.hidden]]">
          <template is="dom-repeat" items="[[row.Members]]" as="rowCaption" index-as="rowCaptionNo">
            <span class="cell row-header"
                  row-number="[[rowNo]]"
                  level$="[[rowCaption.LNum]]"
                  on-tap="_handleRowClick">[[rowCaption.Caption]]</span>
          </template>
          <template is="dom-repeat" items="[[cols.Tuples]]" as="col" index-as="colNo">
            <span class="cell value">[[_getCellValue(data.CellData.Cell, cols.Tuples.length, rowNo, colNo)]]</span>
          </template>
        </div>
      </template>
    </div>
  </template>

  <script>
    Polymer({

      is: 'scary-mdx-table',

      properties: {
        data: {
          type: Object,
          observer: '_dataChanged'
        },

        rows: Array,
        cols: Array,
        rowHeaders: Array,
        colHeaders: Array,
        cells: Array
      },

      _dataChanged: function (data) {
        if (!data) {
          return;
        }
        this.rows = data.Axes[1];
        this.rowHeaders = data.OlapInfo.AxesInfo[1];
        this.cols = data.Axes[0];
        this.colHeaders = data.OlapInfo.AxesInfo[0];
        this._updateRows(0);
      },

      _getColName: function (col, colNo) {
        return col.Members[colNo].Caption;
      },

      _getCellValue: function (cells, cols, row, col) {
        return cells[row * cols + col];
      },

      _handleRowClick: function (e) {
        this.set(['rows.Tuples', e.model.rowNo, 'expanded'], !this.rows.Tuples[e.model.rowNo].expanded);
        this._updateRows(e.model.rowNo);
      },

      _updateRows: function (row) {
        if (!this.data) {
          return;
        }

        var expanded = this.rows.Tuples[row].expanded;
        var parents = [expanded];
        var level = this.rows.Tuples[row].Members[0].LNum;
        var levels = [level];

        if (row === 0) {
          this.set(['rows.Tuples', row, 'hidden'], false);
        }

        for (var i = row + 1; i < this.rows.Tuples.length; i++) {
          if (this.rows.Tuples[i].Members[0].LNum <= level) {
            while (this.rows.Tuples[i].Members[0].LNum <= level) {
              level = levels.pop();
              expanded = parents.pop();
            }
            if (level === undefined) {
              return;
            }
            levels.push(level);
            parents.push(expanded);
          }
          if (this.rows.Tuples[i].Members[0].LNum > level) {
            this.set(['rows.Tuples', i, 'hidden'], !expanded);
            level = this.rows.Tuples[i].Members[0].LNum;
            levels.push(level);
            expanded = expanded && this.rows.Tuples[i].expanded;
            parents.push(expanded);
          }
        }
      }

    });
  </script>
</dom-module>
